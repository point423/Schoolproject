services:
  # 应用服务
  app:
    build: .  # 基于当前目录的Dockerfile构建镜像
    ports:
      - "8080:8080"  # 端口映射
    environment:
      # 数据库连接环境变量（与MySQL服务配置一致）
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/coursehub?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    depends_on:
      - mysql  # 依赖MySQL服务，确保先启动MySQL
    networks:
      - coursehub-network  # 加入自定义网络

  # 数据库服务
  mysql:
    image: mysql:8  # 官方MySQL 8镜像
    ports:
      - "3306:3306"  # 端口映射
    environment:
      MYSQL_ROOT_PASSWORD: root123  # 根密码
      MYSQL_DATABASE: coursehub  # 初始化数据库名
    volumes:
      - mysql-data:/var/lib/mysql  # 数据卷持久化
    networks:
      - coursehub-network  # 加入自定义网络
    healthcheck:  # 健康检查（避免应用启动时MySQL未就绪）
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 5

# 自定义网络（bridge驱动）
networks:
  coursehub-network:
    driver: bridge

# 命名数据卷（持久化MySQL数据）
volumes:
  mysql-data:
